<!doctype html>
<html>
    <head>
        <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />

        <title>Babylon.js sample code</title>

        <!-- Babylon.js -->
        <script src="https://cdnjs.cloudflare.com/ajax/libs/dat-gui/0.6.2/dat.gui.min.js"></script>
        <script src="https://assets.babylonjs.com/generated/Assets.js"></script>
        <script src="https://cdn.babylonjs.com/recast.js"></script>
        <script src="https://cdn.babylonjs.com/ammo.js"></script>
        <script src="https://cdn.babylonjs.com/havok/HavokPhysics_umd.js"></script>
        <script src="https://cdn.babylonjs.com/cannon.js"></script>
        <script src="https://cdn.babylonjs.com/Oimo.js"></script>
        <script src="https://cdn.babylonjs.com/earcut.min.js"></script>
        <script src="https://cdn.babylonjs.com/babylon.js"></script>
        <script src="https://cdn.babylonjs.com/materialsLibrary/babylonjs.materials.min.js"></script>
        <script src="https://cdn.babylonjs.com/proceduralTexturesLibrary/babylonjs.proceduralTextures.min.js"></script>
        <script src="https://cdn.babylonjs.com/postProcessesLibrary/babylonjs.postProcess.min.js"></script>
        <script src="https://cdn.babylonjs.com/loaders/babylonjs.loaders.js"></script>
        <script src="https://cdn.babylonjs.com/serializers/babylonjs.serializers.min.js"></script>
        <script src="https://cdn.babylonjs.com/gui/babylon.gui.min.js"></script>
        <script src="https://cdn.babylonjs.com/addons/babylonjs.addons.min.js"></script>
        <script src="https://cdn.babylonjs.com/inspector/babylon.inspector.bundle.js"></script>

        <style>
            html,
            body {
                overflow: hidden;
                width: 100%;
                height: 100%;
                margin: 0;
                padding: 0;
            }

            #renderCanvas {
                width: 100%;
                height: 100%;
                touch-action: none;
            }

            #canvasZone {
                width: 100%;
                height: 100%;
            }
        </style>
    </head>
    <body>
        <div id="canvasZone"><canvas id="renderCanvas"></canvas></div>
        <script>
                    var canvas = document.getElementById("renderCanvas");

                    var startRenderLoop = function (engine, canvas) {
                        engine.runRenderLoop(function () {
                            if (sceneToRender && sceneToRender.activeCamera) {
                                sceneToRender.render();
                            }
                        });
                    }

                    var engine = null;
        var scene = null;
        var sceneToRender = null;
        var createDefaultEngine = function() { return new BABYLON.Engine(canvas, true, { preserveDrawingBuffer: true, stencil: true,  disableWebGL2Support: false}); };
        
var createScene = async function () {
  const scene = new BABYLON.Scene(engine);

  // 桌面调试:相机+光;进入 AR 后由 XR 相机接管
  scene.createDefaultCameraOrLight(true, true, true);
  scene.createDefaultEnvironment({ createGround: false, environmentTexture: false });

  // ======= 简易 HUD 与 “选择 .glb” 按钮 =======
  const hud = document.createElement("div");
  hud.style.cssText = "position:fixed;left:8px;top:8px;z-index:99;background:#000a;color:#fff;padding:8px 10px;border-radius:10px;font:12px/1.4 system-ui";
  hud.innerHTML = "WebXR:对准平面 → 轻触/右手扳机放置;右手摇杆在水平面移动。需 HTTPS 与 AR 设备支持。";
  document.body.appendChild(hud);

  const pickWrap = document.createElement("div");
  pickWrap.style.cssText = "position:fixed;left:8px;top:64px;z-index:99";
  const pickBtn = document.createElement("button");
  pickBtn.textContent = "选择 .glb";
  pickBtn.style.cssText = "padding:6px 10px;border-radius:8px;border:0;background:#3b82f6;color:#fff;cursor:pointer";
  const fileInput = document.createElement("input");
  fileInput.type = "file"; fileInput.accept = ".glb,model/gltf-binary";
  fileInput.style.display = "none";
  pickWrap.appendChild(pickBtn); document.body.appendChild(pickWrap);
  pickBtn.onclick = () => fileInput.click();

  // ======= WebXR (immersive-ar) & Hit Test =======
  const xr = await scene.createDefaultXRExperienceAsync({
    uiOptions: { sessionMode: "immersive-ar" },
    optionalFeatures: true,
  });

  const fm = xr.baseExperience.featuresManager;
  const hitTest = fm.enableFeature(BABYLON.WebXRFeatureName.HIT_TEST, "latest", {
    entityTypes: ["plane", "mesh"],
    offsetRay: new BABYLON.Ray(new BABYLON.Vector3(0, 0, 0), new BABYLON.Vector3(0, 0, 1), 20),
  });

  let lastHitPose = null;
  hitTest.onHitTestResultObservable.add((results) => {
    if (results && results.length) {
      lastHitPose = results[0].transformationMatrix.clone();
    }
  });

  // ======= 模型加载与放置 =======
  let originalRoot = null;
  let placedRoot = null;

  async function loadFromFile(file) {
    hud.innerHTML = "正在加载:" + file.name;
    const { meshes } = await BABYLON.SceneLoader.ImportMeshAsync("", "", file, scene);
    originalRoot = meshes.find(m => !m.parent) || meshes[0];
    meshes.forEach(m => m.setEnabled(false)); // 原始层级隐藏,放置时再启用

    // 自动缩放至 ~0.35 m 包围盒
    const bb0 = originalRoot.getHierarchyBoundingVectors();
    const size = bb0.max.subtract(bb0.min);
    const maxDim = Math.max(size.x, size.y, size.z);
    const scale = maxDim > 0 ? 0.35 / maxDim : 1.0;
    originalRoot.scaling.scaleInPlace(scale);

    // 如需朝向修正:originalRoot.rotation.x = -Math.PI / 2;

    originalRoot.computeWorldMatrix(true);
    hud.innerHTML = "模型已加载。对准平面,轻触或右手扳机放置。";
  }

  function placeAtHit() {
    if (!originalRoot || !lastHitPose) return;

    if (!placedRoot) {
      placedRoot = originalRoot.clone("placedRoot");
      placedRoot.getChildMeshes(true).forEach(m => m.setEnabled(true));
    }
    placedRoot.setEnabled(true);
    placedRoot.setPreTransformMatrix(lastHitPose);

    // “落地”:按包围盒 minY 调整高度
    const bb = placedRoot.getHierarchyBoundingVectors(true);
    const minY = bb.min.y;
    if (isFinite(minY)) placedRoot.position.y -= minY;

    placedRoot.computeWorldMatrix(true);
  }

  // 文件选择回调(请使用 .glb)
  fileInput.onchange = () => {
    const f = fileInput.files && fileInput.files[0];
    if (!f) return;
    if (!f.name.toLowerCase().endsWith(".glb")) {
      hud.innerHTML = "请选择 .glb 文件(单文件二进制)。";
      return;
    }
    loadFromFile(f);
  };

  // 无手柄:轻触/点击放置
  xr.baseExperience.sessionManager.onSelectObservable.add(() => placeAtHit());

  // 右手手柄:扳机放置,摇杆平移
  xr.input.onControllerAddedObservable.add((xrController) => {
    if (xrController.inputSource.handedness !== "right") return;
    xrController.onMotionControllerInitObservable.add((mc) => {
      const trigger = mc.getComponentOfType("trigger");
      trigger.onButtonStateChangedObservable.add(() => {
        if (trigger.pressed) placeAtHit();
      });

      const stick = mc.getComponentOfType("xr-standard-thumbstick");
      const speed = 0.0025; // 每毫秒移动系数
      scene.onBeforeRenderObservable.add(() => {
        if (!placedRoot || !stick || !stick.axes) return;
        const dx = stick.axes.x || 0;
        const dy = stick.axes.y || 0;
        if (Math.abs(dx) < 0.01 && Math.abs(dy) < 0.01) return;
        const dt = engine.getDeltaTime();
        const pos = placedRoot.getAbsolutePosition().clone();
        pos.x += dx * speed * dt;
        pos.z += dy * speed * dt;
        placedRoot.setAbsolutePosition(pos);
      });
    });
  });

  return scene;
};
                window.initFunction = async function() {
                    
                    
                    
                    var asyncEngineCreation = async function() {
                        try {
                        return createDefaultEngine();
                        } catch(e) {
                        console.log("the available createEngine function failed. Creating the default engine instead");
                        return createDefaultEngine();
                        }
                    }

                    window.engine = await asyncEngineCreation();
                    
                    const engineOptions = window.engine.getCreationOptions?.();
                    if (!engineOptions || engineOptions.audioEngine !== false) {
                        
                    }
        if (!engine) throw 'engine should not be null.';
        startRenderLoop(engine, canvas);
        window.scene = createScene();};
        initFunction().then(() => {scene.then(returnedScene => { sceneToRender = returnedScene; });
        
                    });

                    // Resize
                    window.addEventListener("resize", function () {
                        engine.resize();
                    });
        </script>
    </body>
</html>
